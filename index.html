<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FOOTBALL FACTORY ‚Äî Supabase</title>

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#0b0f14;
      --border:#223247;
      --text:#e7eef8;
      --muted:#9fb1c7;
      --accent:#6ee7ff;
      --accent2:#a78bfa;
      --good:#22c55e;
      --bad:#ef4444;
      --warn:#f59e0b;
      --shadow: 0 10px 25px rgba(0,0,0,.35);
      --radius: 14px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:var(--font); color:var(--text); background:
        radial-gradient(900px 600px at 15% 10%, rgba(110,231,255,.10), transparent 60%),
        radial-gradient(900px 600px at 85% 0%, rgba(167,139,250,.10), transparent 60%),
        var(--bg);
    }
    a{color:inherit}
    .app{display:grid; grid-template-columns:280px 1fr; min-height:100vh}
    .sidebar{
      position:sticky; top:0; height:100vh;
      border-right:1px solid var(--border);
      background: linear-gradient(180deg, rgba(16,24,36,.95), rgba(12,16,22,.95));
      padding:18px;
    }
    .brand{
      display:flex; gap:12px; align-items:center;
      padding:14px; border:1px solid var(--border); border-radius:var(--radius);
      background:rgba(255,255,255,.03); box-shadow:var(--shadow);
    }
    .logo{
      width:44px; height:44px; border-radius:12px;
      overflow:hidden; display:flex; align-items:center; justify-content:center;
      background: conic-gradient(from 220deg, var(--accent), var(--accent2), var(--accent));
      box-shadow: 0 0 0 2px rgba(255,255,255,.08) inset;
    }
    .logo img{
      width:100%;height:100%;
      object-fit:contain;
      object-position:center;
      display:block;
      background:rgba(0,0,0,.12);
    }
    .brand h1{font-size:14px; margin:0; letter-spacing:.6px}
    .brand p{margin:2px 0 0; font-size:12px; color:var(--muted)}
    .nav{margin-top:16px; display:flex; flex-direction:column; gap:8px}
    .nav button{
      width:100%; text-align:left; cursor:pointer;
      padding:12px 12px; border-radius:12px;
      border:1px solid transparent;
      background:transparent; color:var(--text);
      display:flex; align-items:center; gap:10px;
    }
    .nav button:hover{background:rgba(255,255,255,.04); border-color:rgba(255,255,255,.06)}
    .nav button.active{background:rgba(110,231,255,.10); border-color:rgba(110,231,255,.18)}
    .chip{
      margin-left:auto; font-size:11px; color:var(--muted);
      padding:3px 8px; border-radius:999px; border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.03);
    }
    .content{padding:22px; max-width:1400px}
    .topbar{
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      margin-bottom:16px; flex-wrap:wrap;
    }
    .topbarBox{
      display:flex; align-items:center; gap:10px;
      padding:10px 12px; border:1px solid var(--border); border-radius:12px;
      background:rgba(255,255,255,.03);
      flex-wrap:wrap;
    }
    .btn{
      cursor:pointer; border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.04);
      color:var(--text);
      padding:10px 12px; border-radius:12px;
    }
    .btn:hover{background:rgba(255,255,255,.06)}
    .btn.primary{border-color:rgba(110,231,255,.30); background:rgba(110,231,255,.12)}
    .btn.danger{border-color:rgba(239,68,68,.35); background:rgba(239,68,68,.10)}
    .btn.small{padding:7px 10px; border-radius:10px; font-size:12px}
    .card{
      border:1px solid var(--border); border-radius:var(--radius);
      background:rgba(255,255,255,.03);
      box-shadow:var(--shadow);
      padding:18px;
    }
    .hide{display:none !important}
    .row{display:flex; gap:10px; flex-wrap:wrap}
    .field{display:flex; flex-direction:column; gap:6px; flex:1; min-width:180px; margin:8px 0}
    label{font-size:12px; color:var(--muted)}
    input, select, textarea{
      border:1px solid rgba(255,255,255,.10);
      background:rgba(10,14,20,.65);
      color:var(--text);
      padding:10px 10px;
      border-radius:12px;
      outline:none;
    }
    table{
      width:100%; border-collapse:collapse; overflow:hidden;
      border:1px solid rgba(255,255,255,.08);
      border-radius:14px;
    }
    th, td{
      padding:10px 10px; font-size:12px; border-bottom:1px solid rgba(255,255,255,.07);
      vertical-align:top;
    }
    th{ text-align:left; color:var(--muted); background:rgba(255,255,255,.03); }
    .muted{color:var(--muted)}
    .hr{height:1px; background:rgba(255,255,255,.08); margin:14px 0}
    .pill{
      display:inline-flex; align-items:center; gap:6px;
      padding:4px 8px; border-radius:999px; font-size:11px;
      border:1px solid rgba(255,255,255,.12); background:rgba(255,255,255,.03);
      color:var(--muted);
    }
    .dot{width:8px;height:8px;border-radius:50%}
    .dot.good{background:var(--good)} .dot.bad{background:var(--bad)} .dot.warn{background:var(--warn)}

    .avatar{
      width:54px;height:54px;border-radius:16px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.04);
      overflow:hidden; display:flex; align-items:center; justify-content:center;
    }
    .avatar img{width:100%;height:100%;object-fit:cover;object-position:center}

    dialog{
      width:min(720px, 94vw);
      border:1px solid rgba(255,255,255,.12);
      border-radius:16px;
      background:linear-gradient(180deg, rgba(16,24,36,.98), rgba(10,14,20,.98));
      color:var(--text);
      box-shadow:var(--shadow);
    }
    dialog::backdrop{background:rgba(0,0,0,.55)}
    .dlg-top{display:flex; justify-content:space-between; align-items:center; gap:12px}
    .x{
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.04);
      color:var(--text);
      width:36px; height:36px;
      border-radius:12px; cursor:pointer;
    }

    /* AUTH OVERLAY */
    .authOverlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,.65);
      display:flex; align-items:center; justify-content:center;
      z-index:9999;
    }
    .authOverlay.hide{ display:none; }
    .authCard{
      width:min(520px, 92vw);
      border-radius:18px;
      border:1px solid rgba(255,255,255,.10);
      background:
        radial-gradient(900px 600px at 50% 0%, rgba(110,231,255,.08), transparent 55%),
        linear-gradient(180deg, rgba(16,24,36,.98), rgba(10,14,20,.98));
      box-shadow: 0 20px 45px rgba(0,0,0,.55);
      padding:26px;
    }
    .authTitle{ font-size:26px; font-weight:900; margin:0 0 6px; }
    .authSubtitle{ color:var(--muted); margin:0 0 18px; }
    .authLinks{
      display:flex; justify-content:space-between; gap:12px;
      font-size:12px; margin-top:8px;
    }
    .authLinks a{ color: var(--accent); text-decoration:none; }
    .authLinks a:hover{ text-decoration:underline; }
    .authBtn{
      width:100%;
      margin-top:18px;
      padding:14px 12px;
      border-radius:999px;
      font-weight:900;
      letter-spacing:1px;
    }

    @media (max-width: 980px){
      .app{grid-template-columns:1fr}
      .sidebar{height:auto; position:relative}
    }
  </style>
</head>

<body>
  <!-- AUTH OVERLAY -->
  <div id="authOverlay" class="authOverlay">
    <div class="authCard">
      <div class="authTitle">Sign In</div>
      <div class="authSubtitle">Access your FOOTBALL FACTORY tools.</div>

      <div class="field">
        <label>Email</label>
        <input id="authEmail" type="email" placeholder="you@example.com" autocomplete="email">
      </div>

      <div class="field">
        <label>Password</label>
        <input id="authPass" type="password" placeholder="Enter your password" autocomplete="current-password">
      </div>

      <div class="authLinks">
        <a href="#" id="btnSignupLink">New here? <b>Create account</b></a>
        <a href="#" id="btnForgot">Forgot password?</a>
      </div>

      <button class="btn primary authBtn" id="btnLogin">LOGIN</button>

      <div class="muted" style="margin-top:10px;font-size:12px" id="authMsg"></div>
    </div>
  </div>

  <div class="app">
    <aside class="sidebar">
      <div class="brand">
        <div class="logo" id="brandLogo"></div>
        <div>
          <h1 id="brandTitle">FOOTBALL FACTORY</h1>
          <p class="muted" id="brandSub">Supabase connected</p>
        </div>
      </div>

      <nav class="nav" id="nav">
        <button class="active" data-view="dashboard">üèüÔ∏è Dashboard <span class="chip">team</span></button>
        <button data-view="teams">üë• Teams <span class="chip" id="chipTeams">0</span></button>
        <button data-view="players">üßë Players <span class="chip" id="chipPlayers">0</span></button>
        <button data-view="settings">‚öôÔ∏è Settings</button>
      </nav>

      <div class="hr"></div>
      <div class="muted" style="font-size:12px" id="userBadge">Not signed in</div>
    </aside>

    <main class="content">
      <div class="topbar">
        <div class="topbarBox">
          <span class="muted">Club:</span>
          <select id="clubSelect"></select>
          <button class="btn small" id="btnOpenCreateClub">+ Club</button>

          <span class="muted">Current category:</span>
          <select id="teamSelect"></select>
          <span class="pill" id="teamScopePill"><span class="dot warn"></span> no team selected</span>
        </div>

        <div class="row">
          <button class="btn" id="btnRefresh">Refresh</button>
          <button class="btn danger" id="btnLogoutTop">Logout</button>
        </div>
      </div>

      <!-- DASHBOARD -->
      <section class="card" id="view-dashboard">
        <h2 style="margin:0 0 10px;font-size:14px">Dashboard</h2>
        <div class="muted">
          You are connected to Supabase. Teams/Players are loaded from database. (Next: Events/Attendance/Staff.)
        </div>
      </section>

      <!-- TEAMS -->
      <section class="card hide" id="view-teams">
        <h2 style="margin:0 0 10px;font-size:14px">Teams (Supabase)</h2>

        <div class="row">
          <div class="field">
            <label>Team name</label>
            <input id="teamName" placeholder="U13, U15, Women..." />
          </div>
          <div class="field">
            <label>Coaches (comma separated)</label>
            <input id="teamCoaches" placeholder="J. Smith, M. Doe" />
          </div>
        </div>
        <button class="btn primary" id="btnAddTeam">Add team</button>

        <div class="hr"></div>
        <table>
          <thead>
            <tr>
              <th>Team</th>
              <th>Coaches</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="teamsTbody"></tbody>
        </table>

        <div class="muted" style="margin-top:10px;font-size:12px" id="teamsMsg"></div>
      </section>

      <!-- PLAYERS -->
      <section class="card hide" id="view-players">
        <h2 style="margin:0 0 10px;font-size:14px">Players (Supabase, team scoped)</h2>

        <div class="row">
          <div class="field">
            <label>Full name</label>
            <input id="pName" placeholder="Full name">
          </div>
          <div class="field">
            <label>Date of birth</label>
            <input id="pDob" type="date">
          </div>
        </div>

        <div class="row">
          <div class="field">
            <label>Jersey number</label>
            <input id="pJersey" type="number" min="0" placeholder="10">
          </div>
          <div class="field">
            <label>Positions (e.g. CB/CM/CDM)</label>
            <input id="pPos" placeholder="CB/CM">
          </div>
        </div>

        <div class="row">
          <div class="field">
            <label>Parent contacts</label>
            <input id="pParent" placeholder="phone/email">
          </div>
          <div class="field">
            <label>Photo upload (PNG/JPG)</label>
            <input id="pPhoto" type="file" accept="image/png,image/jpeg">
            <div class="muted" style="font-size:12px">Stored in Supabase Storage (player-photos)</div>
          </div>
        </div>

        <button class="btn primary" id="btnAddPlayer">Add player to current team</button>

        <div class="hr"></div>
        <table>
          <thead>
            <tr>
              <th>Photo</th>
              <th>Player</th>
              <th>Jersey</th>
              <th>Positions</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="playersTbody"></tbody>
        </table>

        <div class="muted" style="margin-top:10px;font-size:12px" id="playersMsg"></div>
      </section>

      <!-- SETTINGS -->
      <section class="card hide" id="view-settings">
        <h2 style="margin:0 0 10px;font-size:14px">Settings</h2>
        <div class="muted">Club name + logo stored in Supabase. Logo uses Storage bucket <b>club-logos</b>.</div>

        <div class="row">
          <div class="field">
            <label>Club name</label>
            <input id="clubNameInput" placeholder="FOOTBALL FACTORY">
          </div>
          <div class="field">
            <label>Club logo (PNG/JPG)</label>
            <input id="clubLogoFile" type="file" accept="image/png,image/jpeg">
          </div>
        </div>

        <div class="row">
          <button class="btn primary" id="btnSaveClub">Save club</button>
        </div>

        <div class="hr"></div>
        <div class="muted" style="font-size:12px" id="settingsMsg"></div>
      </section>

    </main>
  </div>

  <!-- Create club dialog -->
  <dialog id="clubDlg">
    <div class="dlg-top">
      <h3 style="margin:0;font-size:14px">Create Club</h3>
      <button class="x" id="clubDlgClose">‚úï</button>
    </div>
    <div class="hr"></div>
    <div class="field">
      <label>Club name</label>
      <input id="newClubName" placeholder="FOOTBALL FACTORY">
    </div>
    <div class="row">
      <button class="btn primary" id="btnCreateClub">Create</button>
      <button class="btn" id="btnCancelCreateClub">Cancel</button>
    </div>
    <div class="muted" style="margin-top:10px;font-size:12px" id="clubCreateMsg"></div>
  </dialog>

  <!-- Player dialog -->
  <dialog id="playerDlg">
    <div class="dlg-top">
      <h3 style="margin:0;font-size:14px" id="playerDlgTitle">Player</h3>
      <button class="x" id="playerDlgClose">‚úï</button>
    </div>
    <div class="hr"></div>
    <div class="row" style="align-items:flex-start">
      <div class="avatar" id="playerAvatar"></div>
      <div style="flex:1">
        <div style="font-size:18px;font-weight:900" id="ppName">‚Äî</div>
        <div class="muted" id="ppMeta">‚Äî</div>
        <div class="muted" id="ppParent">‚Äî</div>
      </div>
    </div>
    <div class="hr"></div>
    <div class="row">
      <button class="btn danger" id="btnDeletePlayer">Delete player</button>
    </div>
  </dialog>

<script>
  // =========================
  // Supabase connection
  // =========================
  const SUPABASE_URL = "https://erwuthbupxazsogxblpv.supabase.co";
  const SUPABASE_ANON_KEY =
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVyd3V0aGJ1cHhhenNvZ3hibHB2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU4MjgyMjUsImV4cCI6MjA4MTQwNDIyNX0.EB-o4onhhs6jkScQYq0oyX1YDFv2cloDUGHpULjUCvQ";
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // =========================
  // Helpers
  // =========================
  const $ = (id) => document.getElementById(id);
  const esc = (s) => String(s ?? "").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
  const escAttr = (s) => esc(s).replaceAll('"',"&quot;");
  function setMsg(el, txt){ el.textContent = txt || ""; }
  function setHide(el, hide){ el.classList.toggle("hide", !!hide); }

  function showAuthOverlay(show){
    $("authOverlay").classList.toggle("hide", !show);
    document.body.style.overflow = show ? "hidden" : "";
  }

  // =========================
  // App state
  // =========================
  let sessionUser = null;
  let currentClubId = "";
  let currentTeamId = "";
  let clubsCache = [];
  let teamsCache = [];

  // =========================
  // Navigation
  // =========================
  const views = ["dashboard","teams","players","settings"];
  $("nav").addEventListener("click", (e)=>{
    const btn = e.target.closest("button[data-view]");
    if(!btn) return;
    const view = btn.dataset.view;
    document.querySelectorAll(".nav button").forEach(b=>b.classList.toggle("active", b===btn));
    views.forEach(v => $("view-"+v).classList.toggle("hide", v!==view));
  });

  // =========================
  // Auth overlay actions
  // =========================
  $("btnLogin").onclick = async () => {
    setMsg($("authMsg"), "");
    const email = $("authEmail").value.trim();
    const password = $("authPass").value;
    const { error } = await supabase.auth.signInWithPassword({ email, password });
    if(error) setMsg($("authMsg"), error.message);
  };

  $("btnSignupLink").onclick = async (e) => {
    e.preventDefault();
    setMsg($("authMsg"), "");
    const email = $("authEmail").value.trim();
    const password = $("authPass").value;
    const { error } = await supabase.auth.signUp({ email, password });
    setMsg($("authMsg"), error ? error.message : "Account created. Now sign in.");
  };

  $("btnForgot").onclick = async (e) => {
    e.preventDefault();
    setMsg($("authMsg"), "");
    const email = $("authEmail").value.trim();
    if(!email) return setMsg($("authMsg"), "Enter your email first.");
    const { error } = await supabase.auth.resetPasswordForEmail(email);
    setMsg($("authMsg"), error ? error.message : "Password reset email sent.");
  };

  $("btnLogoutTop").onclick = async ()=>{
    await supabase.auth.signOut();
  };

  supabase.auth.onAuthStateChange(async (_event, session) => {
    sessionUser = session?.user || null;
    await hardRefreshApp();
  });

  // =========================
  // Club dialog
  // =========================
  const clubDlg = $("clubDlg");
  $("clubDlgClose").onclick = ()=> clubDlg.close();
  $("btnCancelCreateClub").onclick = ()=> clubDlg.close();
  $("btnOpenCreateClub").onclick = ()=>{
    if(!sessionUser) return;
    setMsg($("clubCreateMsg"), "");
    $("newClubName").value = "";
    clubDlg.showModal();
  };

  $("btnCreateClub").onclick = async ()=>{
    if(!sessionUser) return;

    setMsg($("clubCreateMsg"), "");
    const name = $("newClubName").value.trim() || "FOOTBALL FACTORY";

    const { data: club, error } = await supabase
      .from("clubs")
      .insert({ name })
      .select("*")
      .single();

    if(error){
      setMsg($("clubCreateMsg"), error.message);
      return;
    }

    // membership as owner (requires RLS policy allowing self-insert)
    const { error: mErr } = await supabase
      .from("club_members")
      .insert({ club_id: club.id, user_id: sessionUser.id, role: "owner" });

    if(mErr){
      setMsg($("clubCreateMsg"), "Club created but membership failed: " + mErr.message);
      return;
    }

    clubDlg.close();
    currentClubId = club.id;
    currentTeamId = "";
    await hardRefreshApp();
  };

  // =========================
  // Club select
  // =========================
  $("clubSelect").addEventListener("change", async ()=>{
    currentClubId = $("clubSelect").value || "";
    currentTeamId = "";
    await hardRefreshApp();
  });

  // =========================
  // Team select
  // =========================
  $("teamSelect").addEventListener("change", async ()=>{
    currentTeamId = $("teamSelect").value || "";
    renderTeamPill();
    await loadPlayersForTeam(currentTeamId);
  });

  function renderTeamPill(){
    const t = teamsCache.find(x=>x.id===currentTeamId);
    if(!t) $("teamScopePill").innerHTML = `<span class="dot warn"></span> no team selected`;
    else $("teamScopePill").innerHTML = `<span class="dot good"></span> ${esc(t.name)} view`;
  }

  // =========================
  // Load clubs
  // =========================
  async function loadClubsForUser(){
    // clubs via membership
    const { data, error } = await supabase
      .from("club_members")
      .select("club_id, role, clubs:club_id(id,name,logo_path)")
      .eq("user_id", sessionUser.id);

    if(error){
      clubsCache = [];
      return { error };
    }

    clubsCache = (data || [])
      .map(x => ({ id: x.clubs?.id, name: x.clubs?.name, logo_path: x.clubs?.logo_path, role: x.role }))
      .filter(x => x.id);

    return { error: null };
  }

  function renderClubSelect(){
    $("clubSelect").innerHTML =
      (clubsCache.length ? clubsCache.map(c =>
        `<option value="${c.id}">${esc(c.name)} (${esc(c.role)})</option>`
      ).join("") : `<option value="">(no clubs)</option>`);

    $("clubSelect").value = currentClubId || "";
    const club = clubsCache.find(c=>c.id===currentClubId);
    $("clubNameInput").value = club?.name || "";
  }

  async function loadClubBranding(clubId){
    if(!clubId) return;

    const { data, error } = await supabase.from("clubs")
      .select("id,name,logo_path")
      .eq("id", clubId)
      .single();

    if(error) return;

    $("brandTitle").textContent = data.name || "FOOTBALL FACTORY";
    $("clubNameInput").value = data.name || "";

    const brandLogo = $("brandLogo");
    if(data.logo_path){
      const { data: url } = supabase.storage.from("club-logos").getPublicUrl(data.logo_path);
      brandLogo.innerHTML = `<img src="${escAttr(url.publicUrl)}" alt="logo">`;
      brandLogo.style.background = "rgba(255,255,255,.03)";
    }else{
      brandLogo.innerHTML = "";
      brandLogo.style.background = "conic-gradient(from 220deg, var(--accent), var(--accent2), var(--accent))";
    }
  }

  // =========================
  // Teams
  // =========================
  $("btnAddTeam").onclick = async ()=>{
    if(!sessionUser) return alert("Login first.");
    if(!currentClubId) return alert("Select a club first.");

    setMsg($("teamsMsg"), "");
    const name = $("teamName").value.trim();
    if(!name) return alert("Enter team name.");
    const coaches_text = $("teamCoaches").value.split(",").map(s=>s.trim()).filter(Boolean);

    const { error } = await supabase
      .from("teams")
      .insert({ club_id: currentClubId, name, coaches_text });

    if(error){
      setMsg($("teamsMsg"), error.message);
      return;
    }

    $("teamName").value = "";
    $("teamCoaches").value = "";
    await loadTeams(currentClubId);

    if(!currentTeamId) currentTeamId = teamsCache[0]?.id || "";
    renderTeamSelector();
    await loadPlayersForTeam(currentTeamId);
  };

  async function loadTeams(clubId){
    setMsg($("teamsMsg"), "");
    const { data, error } = await supabase
      .from("teams")
      .select("*")
      .eq("club_id", clubId)
      .is("archived_at", null)
      .order("name", { ascending: true });

    if(error){
      teamsCache = [];
      renderTeamsTable([]);
      setMsg($("teamsMsg"), error.message);
      return;
    }

    teamsCache = data || [];
    $("chipTeams").textContent = String(teamsCache.length);
    renderTeamsTable(teamsCache);
  }

  function renderTeamsTable(teams){
    $("teamsTbody").innerHTML = teams.map(t=>`
      <tr>
        <td><b>${esc(t.name)}</b></td>
        <td class="muted">${esc((t.coaches_text||[]).join(", "))}</td>
        <td>
          <button class="btn small" onclick="window.app.setTeam('${t.id}')">View</button>
          <button class="btn small danger" onclick="window.app.deleteTeam('${t.id}')">Delete</button>
        </td>
      </tr>
    `).join("") || `<tr><td colspan="3" class="muted">No teams.</td></tr>`;
  }

  async function deleteTeam(teamId){
    if(!confirm("Delete team?")) return;
    const { error } = await supabase.from("teams").delete().eq("id", teamId);
    if(error) return alert(error.message);

    await loadTeams(currentClubId);
    if(currentTeamId === teamId) currentTeamId = teamsCache[0]?.id || "";
    renderTeamSelector();
    await loadPlayersForTeam(currentTeamId);
  }

  function renderTeamSelector(){
    $("teamSelect").innerHTML =
      `<option value="">(select team)</option>` +
      teamsCache.map(t=>`<option value="${t.id}">${esc(t.name)}</option>`).join("");
    $("teamSelect").value = currentTeamId || "";
    renderTeamPill();
  }

  // =========================
  // Players
  // =========================
  $("btnAddPlayer").onclick = async ()=>{
    if(!sessionUser) return alert("Login first.");
    if(!currentClubId) return alert("Select club first.");
    if(!currentTeamId) return alert("Select team first.");

    setMsg($("playersMsg"), "");

    const full_name = $("pName").value.trim();
    const dob = $("pDob").value;
    const jersey_number = Number($("pJersey").value || 0);
    const positions = $("pPos").value.trim();
    const parent_contacts = $("pParent").value.trim();

    if(!full_name) return alert("Enter full name.");
    if(!dob) return alert("Enter DOB.");

    // 1) create player row
    const { data: player, error: pErr } = await supabase
      .from("players")
      .insert({ club_id: currentClubId, full_name, dob, jersey_number, positions, parent_contacts })
      .select("*")
      .single();

    if(pErr){
      setMsg($("playersMsg"), pErr.message);
      return;
    }

    // 2) upload photo optional
    const file = $("pPhoto").files?.[0] || null;
    if(file){
      const ok = ["image/png","image/jpeg"].includes(file.type);
      if(!ok) return alert("Photo must be PNG/JPG.");

      const ext = (file.type === "image/png") ? "png" : "jpg";
      const path = `${currentClubId}/${player.id}.${ext}`;

      const { error: upErr } = await supabase.storage
        .from("player-photos")
        .upload(path, file, { upsert: true, contentType: file.type });

      if(upErr){
        setMsg($("playersMsg"), "Upload error: " + upErr.message);
        return;
      }

      const { error: uErr } = await supabase
        .from("players")
        .update({ photo_path: path })
        .eq("id", player.id);

      if(uErr){
        setMsg($("playersMsg"), "Photo path save error: " + uErr.message);
        return;
      }
    }

    // 3) assign to team
    const { error: linkErr } = await supabase
      .from("player_teams")
      .insert({ player_id: player.id, team_id: currentTeamId });

    if(linkErr){
      setMsg($("playersMsg"), "Team link error: " + linkErr.message);
      return;
    }

    // clear form
    $("pName").value=""; $("pDob").value=""; $("pJersey").value=""; $("pPos").value=""; $("pParent").value="";
    $("pPhoto").value="";

    await loadPlayersForTeam(currentTeamId);
  };

  async function loadPlayersForTeam(teamId){
    setMsg($("playersMsg"), "");
    if(!teamId){
      renderPlayersTable([]);
      $("chipPlayers").textContent = "0";
      return;
    }

    const { data, error } = await supabase
      .from("player_teams")
      .select("player_id, players:player_id(id,full_name,dob,jersey_number,positions,parent_contacts,photo_path)")
      .eq("team_id", teamId)
      .is("left_at", null);

    if(error){
      renderPlayersTable([]);
      setMsg($("playersMsg"), error.message);
      return;
    }

    const players = (data || []).map(x => x.players).filter(Boolean)
      .sort((a,b)=> (a.full_name||"").localeCompare(b.full_name||""));

    $("chipPlayers").textContent = String(players.length);
    renderPlayersTable(players);
  }

  function playerPhotoUrl(photo_path){
    if(!photo_path) return "";
    const { data: url } = supabase.storage.from("player-photos").getPublicUrl(photo_path);
    return url.publicUrl || "";
  }

  function renderPlayersTable(players){
    $("playersTbody").innerHTML = players.map(p=>{
      const url = playerPhotoUrl(p.photo_path);
      return `
        <tr>
          <td><div class="avatar">${url ? `<img src="${escAttr(url)}" alt="photo">` : `<span class="muted">‚Äî</span>`}</div></td>
          <td>
            <b>${esc(p.full_name)}</b>
            <div class="muted">DOB: ${esc(p.dob)} ‚Ä¢ Parent: ${esc(p.parent_contacts||"‚Äî")}</div>
          </td>
          <td>${Number(p.jersey_number||0)}</td>
          <td class="muted">${esc(p.positions||"")}</td>
          <td><button class="btn small" onclick="window.app.openPlayer('${p.id}')">Profile</button></td>
        </tr>
      `;
    }).join("") || `<tr><td colspan="5" class="muted">No players in this team.</td></tr>`;
  }

  // =========================
  // Player dialog
  // =========================
  const playerDlg = $("playerDlg");
  $("playerDlgClose").onclick = ()=> playerDlg.close();
  let activePlayerId = "";

  async function openPlayer(playerId){
    activePlayerId = playerId;
    const { data: p, error } = await supabase.from("players").select("*").eq("id", playerId).single();
    if(error) return alert(error.message);

    $("playerDlgTitle").textContent = p.full_name;
    $("ppName").textContent = p.full_name;
    $("ppMeta").textContent = `#${Number(p.jersey_number||0)} ‚Ä¢ DOB: ${p.dob || "‚Äî"} ‚Ä¢ ${p.positions || "‚Äî"}`;
    $("ppParent").textContent = `Parent contacts: ${p.parent_contacts || "‚Äî"}`;

    const av = $("playerAvatar");
    const url = playerPhotoUrl(p.photo_path);
    av.innerHTML = url ? `<img src="${escAttr(url)}" alt="photo">` : `<span class="muted">No photo</span>`;

    playerDlg.showModal();
  }

  $("btnDeletePlayer").onclick = async ()=>{
    if(!activePlayerId) return;
    if(!confirm("Delete player completely?")) return;

    const { error } = await supabase.from("players").delete().eq("id", activePlayerId);
    if(error) return alert(error.message);

    playerDlg.close();
    await loadPlayersForTeam(currentTeamId);
  };

  // =========================
  // Settings: club name + logo upload
  // =========================
  $("btnSaveClub").onclick = async ()=>{
    if(!sessionUser) return;
    if(!currentClubId) return alert("Select a club.");

    setMsg($("settingsMsg"), "");

    const name = $("clubNameInput").value.trim() || "FOOTBALL FACTORY";

    // logo optional
    let logo_path = null;
    const file = $("clubLogoFile").files?.[0] || null;

    if(file){
      const ok = ["image/png","image/jpeg"].includes(file.type);
      if(!ok) return alert("Logo must be PNG/JPG.");

      const ext = (file.type === "image/png") ? "png" : "jpg";
      logo_path = `${currentClubId}/logo.${ext}`;

      const { error: upErr } = await supabase.storage
        .from("club-logos")
        .upload(logo_path, file, { upsert: true, contentType: file.type });

      if(upErr){
        setMsg($("settingsMsg"), upErr.message);
        return;
      }
    }

    const payload = { name };
    if(logo_path) payload.logo_path = logo_path;

    const { error } = await supabase.from("clubs").update(payload).eq("id", currentClubId);
    if(error){
      setMsg($("settingsMsg"), error.message);
      return;
    }

    setMsg($("settingsMsg"), "Saved.");
    $("clubLogoFile").value = "";

    await loadClubsForUser();
    renderClubSelect();
    await loadClubBranding(currentClubId);
  };

  // =========================
  // Refresh
  // =========================
  $("btnRefresh").onclick = async ()=> {
    await hardRefreshApp();
  };

  // =========================
  // HARD refresh app after auth/login/logout/save
  // =========================
  async function hardRefreshApp(){
    if(!sessionUser){
      showAuthOverlay(true);
      $("userBadge").textContent = "Not signed in";

      currentClubId = "";
      currentTeamId = "";
      clubsCache = [];
      teamsCache = [];

      $("clubSelect").innerHTML = `<option value="">(login required)</option>`;
      $("teamSelect").innerHTML = `<option value="">(select team)</option>`;
      renderTeamPill();

      $("chipTeams").textContent = "0";
      $("chipPlayers").textContent = "0";
      renderTeamsTable([]);
      renderPlayersTable([]);
      return;
    }

    showAuthOverlay(false);
    $("userBadge").textContent = `Signed in: ${sessionUser.email || sessionUser.id}`;

    const { error } = await loadClubsForUser();
    if(error){
      alert("Club load error: " + error.message);
      return;
    }

    if(clubsCache.length === 0){
      // No club yet -> user must create one
      $("clubSelect").innerHTML = `<option value="">(no clubs ‚Äî click + Club)</option>`;
      $("brandTitle").textContent = "FOOTBALL FACTORY";
      $("brandLogo").innerHTML = "";
      $("brandLogo").style.background = "conic-gradient(from 220deg, var(--accent), var(--accent2), var(--accent))";
      teamsCache = [];
      renderTeamsTable([]);
      renderPlayersTable([]);
      $("chipTeams").textContent = "0";
      $("chipPlayers").textContent = "0";
      return;
    }

    if(!currentClubId || !clubsCache.some(c=>c.id===currentClubId)){
      currentClubId = clubsCache[0].id;
    }

    renderClubSelect();
    await loadClubBranding(currentClubId);

    await loadTeams(currentClubId);
    if(!currentTeamId || !teamsCache.some(t=>t.id===currentTeamId)){
      currentTeamId = teamsCache[0]?.id || "";
    }

    renderTeamSelector();
    await loadPlayersForTeam(currentTeamId);
  }

  function renderClubSelect(){
    $("clubSelect").innerHTML = clubsCache.map(c =>
      `<option value="${c.id}">${esc(c.name)} (${esc(c.role)})</option>`
    ).join("");
    $("clubSelect").value = currentClubId || "";
  }

  // =========================
  // Global onclick API
  // =========================
  window.app = {
    setTeam: async (teamId) => {
      currentTeamId = teamId;
      $("teamSelect").value = teamId;
      renderTeamPill();
      await loadPlayersForTeam(currentTeamId);
    },
    deleteTeam,
    openPlayer
  };

  // =========================
  // Init
  // =========================
  (async function init(){
    const { data } = await supabase.auth.getSession();
    sessionUser = data.session?.user || null;
    await hardRefreshApp();
  })();
</script>
</body>
</html>
